# 实验原理

&emsp;&emsp;虚拟专用网络隧道有多种方法可以实现，最具代表性的两种方法是IPsec隧道和TLS/SSL隧道。IPsec的隧道模式是将整个原始的IP数据包被封装在一个新的IP数据包内，并且添加一个新的头部，在网络层（IP层）完成。TLS/SSL是把每个属于虚拟专用网络的IP数据包传递给特定的应用程序，这个应用程序把数据包放入TCP或者UDP包（一个新的数据包）内，然后把新数据包发送给应用程序在隧道的另一端的对接程序，对接程序将原始数据包从TCP或者UDP包的载荷中提取出来，发送给私有网络。

## 1. TLS/SSL 虚拟专用网络的基本原理

&emsp;&emsp;TLS/SSL隧道时运行在虚拟专用网络客户端和服务器的应用程序之间的一条隧道。

&emsp;&emsp;在Client和Server之间建立一条安全的隧道；

&emsp;&emsp;转发由隧道一段到另一端的IP数据包；

&emsp;&emsp;接收到IP数据包后，把数据包发送到私有网络内。

<center><img src="../assets/3-1.png" width = 600></center>
<center>图3-1 TLS/虚拟专用网络的基本原理</center>

## 2. 虚拟网络接口

&emsp;&emsp;虚拟网络接口对应一个用软件实现的虚拟网卡，可以把计算机和用户空间的程序连接起来。

&emsp;&emsp;TUN接口：作用在网络层（IP层），把数据包发送到TUN接口会使得数据包（包含IP头部）被传递到用户空间的程序。

&emsp;&emsp;TAP接口： 作用在数据链路层，类似一个物理网络适配器，被广泛用于创建网桥。

<center><img src="../assets/3-2.png" width = 600></center>
<center>图3-2 物理接口与虚拟接口的区别</center>

## 3. 数据包在隧道中的详细流程

&emsp;&emsp;虚拟网络接口对应一个用软件实现的虚拟网卡，可以把计算机和用户空间的程序连接起来。

### 2.1 数据包在隧道中的详细流程

&emsp;&emsp;IP数据包由私有网络内的主机产生（见下图的标号2，3）标号2表示来自本机的应用程序的数据包，标号3表示从网络上其他主机产生的数据。如何确保所有传输的的数据包能到达TUN接口？

<center><img src="../assets/3-3.png" width = 600></center>
<center>图3-3 数据包在隧道中的详细流程</center>

### 2.2 将数据包路由到TUN接口

&emsp;&emsp;需要让IP数据包流向虚拟专用网络隧道应用程序所在的计算机，数据包会进入操作系统的网络协议栈，然后由网络协议栈决定要将数据包发送到哪里。也就是根据操作系统内部的路由表决定的，操作系统内部的路由表保存了一系列路由的规则。我们可以在路由表中添加一条规则，让网络协议栈把数据包转发给TUN接口。

    方法1：os.system("ip route add 192.168.60.0/24 dev {}".format(ifname))
    方法2：sudo route add –net 192.168.60.0/24 ifname 

## 4. 实现一个简化的虚拟专用网络

&emsp;&emsp;我们本次实验实现一个简单的虚拟专用网络程序（客户端和服务器），代码简化的内容有如下几点：

&emsp;&emsp;1、实际的TLS/SSL 虚拟专用网络的隧道应该使用基于TCP/UDP的TLS/SSL协议，而我们只建立了基于UDP的隧道，保护隧道安全的内容没有做，有兴趣的同学可以继续完善；

&emsp;&emsp;2、使用系统调用时，程序应该检查返回值以查看调用是否成功，我们并没有进行错误检查的代码。

&emsp;&emsp;具体流程如下，首先创建一个TUN接口，然后使用UDP的socket与另一端建立隧道；之后VNP程序监控TUN接口和socket接口，如果有数据到达TUN接口，则是需要去往另一端私有网络的数据包，应该在传送到因特网前被保护。虚拟专用网络程序会加密这个数据包（本次实验未做），然后把加密消息发送给隧道的另一端。如果数据来自socket接口，则是一个来自虚拟专用网络隧道另一端的UDP数据包。这个数据包的载荷中封装了加密过的IP数据包。虚拟专用网络程序从UDP载荷中取出IP数据包，解密后通过TUN接口发送给内核，内核会把这个数据包路由到位于私有网络的最终目的地。

<center><img src="../assets/3-4.png" width = 600></center>
<center>图3-4 程序流程</center>