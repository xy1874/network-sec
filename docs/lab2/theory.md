# 实验原理

&emsp;&emsp;数据在互联网中传输时如果未受到保护，很容易被其他人读取深圳修改。应用程序为了保证通信的安全性，需要加密数据并且检测数据的完整性。这可以用密码算法来实现，但是目前有很多密码算法，即使同一种算法，也有很多参数可以使用。为例方便不同的应用程序之间彼此通信，它们需要遵循一个共同的标准。传输层协议（TLS）就是这样一个标准。


## 1. TLS概述

&emsp;&emsp;TLS位于应用层和传输层之间，应用程序将未受保护的数据传递给TLS层，TLS层负责加密、解密和完整性检查，然后TLS将受保护的数据提供给传输层进行传输。TLS提供的安全通道具有以下三个属性：
&emsp;&emsp;（1）保密性，除了通道两端以外，没有人可以看到同都内数据的实际内容；
&emsp;&emsp;（2）完整性，如果数据在传输过程中被他人篡改，通道应该能够检测到；
&emsp;&emsp;（3）身份验证：至少服务器端的身份需要被验证，如果没有身份验证，将会出现中间人攻击。

&emsp;&emsp;TLS是建立在TCP传输层上的，但它也可以建立在UDP上。建立的UDP上的TLS叫做DTLS，有兴趣的同学可以查看RFC 6347文件。
&emsp;&emsp;TLS一个分层协议，它由两层组成。底层为记录层由记录协议，上层由5种消息协议组成，包括握手协议、警报协议、更改密码规范协议、心跳协议和应用协议，如下图所示，本次实验只关注握手协议和应用协议。
<center><img src="../assets/1-1.png" width = 200></center>
<center>图1-1 含有TLS层的TCP/IP网络协议栈</center>

握手协议负责建立安全通道，让客户端和服务器共同商定使用的加密算法和密钥、MAC算法、密钥交换算法等加密参数并生成会话密钥；
警报协议用于通信双发发送警报信号，目的是向对方报告失败的原因。
更改密码规范协议用于通知对方改变正在使用的加密方法，通常用于在我说协议结束后告知对方从公钥加密模式切换到密钥加密模式。
心跳协议用于防止TLS会话因为限制太久而被操作系统关闭。著名的心脏滴血攻击就是这个协议实现种的一个漏洞导致的，如果要详细了解可参考链接：https://heartbleed.com/。
应用协议用于通道的实际传输。

## 2. TLS握手

### 2.1 TLS握手过程
&emsp;&emsp;TLS握手协议的目的是让客户端和服务器共同商定加密参数并生成会话密钥。具体步骤如下图所示。

<center><img src="../assets/1-2.png" width = 200></center>
<center>图1-2 TLS握手协议</center>

1、客户端：发送客户端问候消息（Client Hello），表明它自己支持哪些密码套件和客户端的一次性随机数（Client_random）。
2、服务器：发送服务器问候消息（Server Hello），根据客户端发来的问候消息，选择确认一个客户端和服务器都支持的密码套件，并并提供服务器的一次性随机数（Server_random）。
3、服务器：发送公钥证书给客户端。
4、服务器：发送握手完成的消息，表明已完成握手协商。
5、客户端：发送客户端密钥交换消息。客户端随机生成一个预主密钥，然后用服务器的公钥对其进行加密，并将加密后的密钥发送给服务器。客户端和服务器首先使用预主密钥生成主密钥，然后再使用主密钥生成会话密钥。
6、客户端和服务器：互相发送更改密码规范消息。
7、客户端和服务器：互相发送一个加密完成的消息。必须包括一个哈希值和MAC(报文认证码)值，这些值使用握手协议种交换的所有数据生成的。如果双发各自解密验证发来的哈希值和MAC值不对，就说明对方没有正确的密钥或者协议执行过程种出现失败，握手协议将失败，TLS链接会中断。

### 2.2 证书验证

&emsp;&emsp;在TLS握手协议中，上面的第五步，预主密钥在发送给服务器时用服务器的公钥进行加密，由上一次的PKI实验我们可以知道，如果直接发送服务器公钥可能会受到中间人攻击，因此服务器应该给发送一个公钥证书。

&emsp;&emsp;服务器的证书包含服务器的公钥、身份信息、截止日期、CA的签名及其他相关信息。当客户端受到服务器证书时，许哟样证书是否有效。但是并部检查证书中包含的身份信息是否与目标服务器的身份匹配。这一点非常重要，需要应用程序进行检查，如果没有此项检查，中间人攻击也将成为可能。

### 2.3 密钥生成和交换
&emsp;&emsp;上面的第六步，之所以要更改密码规范，是因为公钥算法加密要比对称加密算法慢得多。因此，TLS仅使用公钥算法来帮助客户端和服务器生成一个共同得密钥，一旦密钥生成后，客户端和服务器将切换到米哟啊加密算法。密钥生成过程分为生成预主密钥、生成主密钥和生成会话密钥三个步骤，如下图所示。

<center><img src="../assets/1-3.png" width = 200></center>
<center>图1-3 TLS密钥生成</center>

预主密钥：服务器证书验证成功后，客户端程序会生成一个随机数，称为预主密钥。
主密钥：在TLS前两步中，客户端和服务器交换了两个随机数，分别是Client_random和Server_random。用这两个随机数和签名生成的预主密钥，客户端和服务器端会生成主密钥，长度为48字节。
会话密钥：客户端和服务器双方使用主密钥根据密码算法生成一个字节序列。这个序列进一步分成4个单独的会话密钥：两个MAC密钥和两个加密密钥。

&emsp;&emsp;TLS允许客户端和服务器在会话过程中改变加密参数，这不需要重新执行一次完整的握手协议，只需要将分别生成的Client_random和Server_random发给对方，然后重复主密钥扩展和会话密钥生成步骤即可，主密钥不需要变化。

## 3. TLS数据传输

&emsp;&emsp;完成握手协议后，客户端和服务器双方就可以完成握手协议，它们就可以开始交换数据。数据放在TLS记录中传输，记录的格式由TLS记录协议定义。TLS记录不仅用于传输应用程序数据，还用于传输握手协议和其他TLS子协议总的消息。

&emsp;&emsp;每条记录包含一个头部和一个有效载荷，如下图所示。
<center><img src="../assets/1-4.png" width = 200></center>
<center>图1-4 TLS记录格式</center>

内容类型: 表示当前记录携带TLS的哪个字协议
版本字段：表示消息的TLS主版本和次版本，例如TLS1.3
长度字段：表明有效载荷字段的长度.


